<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Suspension</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="styles.css" rel="stylesheet">
    </head>

    <body class="intro-mode">
        <div id="container">
            <div class="screen" id="s-menu" data-change-menu="unmenu"></div>
            <div id="menu" class="outlined modal">
                <div class="menurow">
                    <button>Save</button>
                    <button>Leaderboard</button>
                </div>
                <p class="menutitle">Sounds</p>
                <div class="menutable">
                    <div class="mtlabel">
                        <label for="effects">Effects</label>
                        <label for="music">Music</label>
                    </div>
                    <div class="mtinput">
                        <input type="range" id="effects">
                        <input type="range" id="music">
                    </div>
                </div>
                <div class="menurow">
                    <button data-change-menu="unmenu">Exit Options</button>
                    <button>Exit Game</button>
                </div>
                <div class="menurow">
                    <button>Report a Bug</button>
                </div>
            </div>

            <div id="bells" class="outlined modal">
                <div id="belltable">
                    <div class="bellrow">
                        <p class="bell-time">Time</p>
                        <p>Mon</p>
                        <p>Tue</p>
                        <p>Wed</p>
                        <p>Thu</p>
                        <p>Fri</p>
                    </div>
                    <div class="bellrow">
                        <p class="bell-time">08:30-09:20</p>
                        <p>A</p>
                        <p>D</p>
                        <p>B</p>
                        <p>E</p>
                        <p>C</p>
                    </div>
                    <div class="bellrow">
                        <p class="bell-time">09:30-10:50</p>
                        <p>B</p>
                        <p>E</p>
                        <p>C</p>
                        <p>B</p>
                        <p>D</p>
                    </div>
                    <div class="bellrow">
                        <p class="bell-time">11:00-12:20</p>
                        <p>C</p>
                        <p>B</p>
                        <p>D</p>
                        <p>C</p>
                        <p>E</p>
                    </div>
                    <div class="bellrow">
                        <p class="bell-time">12:20-01:00</p>
                    </div>
                    <div class="bellrow">
                        <p class="bell-time">01:00-02:20</p>
                        <p>F</p>
                        <p>A</p>
                        <p>E</p>
                        <p>D</p>
                        <p>A</p>
                    </div>
                    <div class="bellrow">
                        <p class="bell-time">02:30-03:50</p>
                        <p></p>
                        <p>F</p>
                        <p>F</p>
                        <p>A</p>
                        <p>F</p>
                    </div>
                    <button data-change-menu="unmenu">Close Schedule</button>
                </div>
            </div>

            <div id="layout" class="outlined modal">
                <div id="laytable">
                    <div class="layrow">
                        <p>2</p>
                        <p>3</p>
                        <p>4</p>
                        <p></p>
                        <p>7</p>
                        <p>8</p>
                        <p>9</p>
                        <p></p>
                        <p>12</p>
                        <p>13</p>
                        <p>14</p>
                    </div>
                    <div class="layrow">
                        <p>1</p>
                        <p class="layb">W</p>
                        <p>5</p>
                        <p></p>
                        <p>6</p>
                        <p class="layb">U</p>
                        <p>10</p>
                        <p></p>
                        <p>11</p>
                        <p class="layb">M</p>
                        <p>15</p>
                    </div>
                    <div class="layrow">
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                        <p></p>
                    </div>
                    <div class="layrow">
                        <p>30</p>
                        <p class="layb">M</p>
                        <p>26</p>
                        <p></p>
                        <p>25</p>
                        <p class="layb">U</p>
                        <p>21</p>
                        <p></p>
                        <p>20</p>
                        <p class="layb">W</p>
                        <p>16</p>
                    </div>
                    <div class="layrow">
                        <p>29</p>
                        <p>28</p>
                        <p>27</p>
                        <p></p>
                        <p>24</p>
                        <p>23</p>
                        <p>22</p>
                        <p></p>
                        <p>19</p>
                        <p>18</p>
                        <p>17</p>
                    </div>
                    <button data-change-menu="unmenu">Close Map</button>
                </div>
            </div>

            <div id="controls" class="outlined">
                <p>Mon 05/12</p>
                <p>10:00 AM</p>
                <button data-change-menu="bells">Schedule</button> <!--if you are wondering why they have weird id's-->
                <button data-change-menu="layout">Map</button> <!--it's cuz i already used both "schedule" and "map"-->
                <div class="stretch"></div> <!--and i'm too lazy to change everything.-->
                <div class="control-btns">
                    <button data-switch-screen="game">Computer</button>
                    <button data-switch-screen="office">Office</button>
                    <button data-change-menu="menu">Menu</button>
                </div>
            </div>
            <div id="game" class="game-screen">

                <div id="campanel" class="campanel panel left-panel">
                    <div id="camchoose">
                        <div id="map">
                            <div class="maprow">
                                <div class="mapbox">
                                    <button>CamA2</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamB2</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamC2</button>
                                </div>
                            </div>
                            <div class="maprow mbuild">
                                <div class="mapbox"></div>
                                <div class="mapbox"></div>
                                <div class="mapbox"></div>
                            </div>
                            <div class="maprow mbot">
                                <div class="mapbox">
                                    <button>CamA1</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamB1</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamC1</button>
                                </div>
                            </div>
                            <div class="maprow">
                                <div class="mapbox">
                                    <button>CamF1</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamE1</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamD1</button>
                                </div>
                            </div>
                            <div class="maprow mbuild">
                                <div class="mapbox"></div>
                                <div class="mapbox"></div>
                                <div class="mapbox"></div>
                            </div>
                            <div class="maprow mbot">
                                <div class="mapbox">
                                    <button>CamF2</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamE2</button>
                                </div>
                                <div class="mapbox">
                                    <button>CamD2</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="camdetect">
                        <div class="student">
                            <div class="spic"></div>
                            <p class="sname">Munkler,<br>Leuf</p>
                        </div>
                        <div class="student">
                            <div class="spic"></div>
                            <p class="sname">Munkler,<br>Leuf</p>
                        </div>
                        <div class="student">
                            <div class="spic"></div>
                            <p class="sname">Munkler,<br>Leuf</p>
                        </div>
                        <div class="student">
                            <div class="spic"></div>
                            <p class="sname">Munkler,<br>Leuf</p>
                        </div>
                        <div class="student">
                            <div class="spic"></div>
                            <p class="sname">Munkler,<br>Leuf</p>
                        </div>
                        <div class="student">
                            <div class="spic"></div>
                            <p class="sname">Munkler,<br>Leuf</p>
                        </div>
                    </div>
                    <div id="camvis" class="outlined"></div>
                </div>

                <button class="toggle-panel-btn">&gt;</button>

                <div id="infopanel" class="panel right-panel">
                    <div id="directory" class="outlined">
                        <input id="search" type="text" placeholder="Search" autocomplete="off" spellcheck="false">
                        <div id="listwrap" class="list-wrap">
                            <div id="list" class="list"></div>
                        </div>
                    </div>
                    <div id="schedule" class="outlined">
                        <div id="table">
                            <div class="tablerow">
                                <p>&mdash;</p>
                                <p>Class Name</p>
                                <p>Rm</p>
                            </div>
                            <div class="tablerow" id="tlist0"></div>
                            <div class="tablerow" id="tlist1"></div>
                            <div class="tablerow" id="tlist2"></div>
                            <div class="tablerow" id="tlist3"></div>
                            <div class="tablerow" id="tlist4"></div>
                            <div class="tablerow" id="tlist5"></div>
                            <button>Summon</button>
                        </div>
                    </div>
                </div>

            </div>

            <div id="office" class="game-screen">

                <div id="envpanel" class="panel left-panel">
                    <div id="envvis" class="outlined">insert drag and drop backpack desk here</div>
                </div>

                <button class="toggle-panel-btn">&gt;</button>

                <div id="studentpanel" class="panel right-panel">
                    <div id="studentview" class="outlined">insert face here</div>
                    <div id="dialogue" class="outlined">
                        <p class="sname">Ovinus Real</p>
                        <div id="transwrap" class="list-wrap">
                            <div id="transcript" class="list">
                                <p><span class="tjoin">Ovinus entered the office</span></p>
                                <p><span class="tname">Ovinus: </span>When I was young. When I was young. When I was young. When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>If you <span class="trel">release</span> me, I'll tell you who gives us all the drugs.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                                <p><span class="tname">Ovinus: </span>When I was young.</p>
                                <p><span class="tname">Tech Guy: </span>I love gamepro5.</p>
                            </div>
                        </div>
                        <div id="studentoptions">
                            <div id="talk">
                                <button>Interrogate</button>
                                <button>Bargain</button>
                                <button id="release">Release</button>
                            </div>
                            <div id="sustitle">
                                <p>Suspend</p>
                            </div>
                            <div id="suspend">
                                <button>Drugs</button>
                                <button>Disobediance</button>
                                <button>Bullying</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <script type="module">
            import '../focus-visible.js';
            import * as SCHOOL from '../../school/school.js';
            import * as SCHEDULE from '../../school/schedule.js';
            import {SpriteCache} from '../../characters/sprites/sprite-cache.js';
            import {getWorkerSpriteMaker, param} from '../../centralized.js';
            import {Directory} from './directory.js';
            import {Dialogue} from '../sean/dialogue.js';

            async function intro(showUI) {
                const introData = fetch('./intro-dialogue.json').then(r => r.json());
                const demoData = fetch('../sean/principal-demo.json').then(r => r.json());

                const intro = new Dialogue({wrapperClass: 'intro'});
                const demo = new Dialogue({
                    measureHeight: false,
                    wrapperClass: 'principal-demo'
                });

                await introData; // Wait for intro data to load first
                const data = await intro.addTo(document.body)
                    .start(await introData, {
                        intro: '../sean/munkler.png',
                        principal: '../../characters/sprites/images/munkler/sprite.png'
                    });
                intro.removeFromParent();

                await showUI();

                // The part where the principal introduces parts of the UI
                await demo.addTo(document.body)
                    .start(await demoData, {
                        principal: '../../characters/sprites/images/munkler/sprite.png'
                    });
                demo.removeFromParent();

                // TODO: Do something with whatever the player drew?
                return data;
            }

            // Toggle panel buttons for small screen
            let togglePanelBtns = document.getElementsByClassName('toggle-panel-btn');
            for (let btn of togglePanelBtns) {
                btn.addEventListener('click', () => {
                    document.body.classList.toggle('show-right-panel');
                    if (document.body.classList.contains('show-right-panel')) {
                        for (let btn of togglePanelBtns) btn.textContent = '<';
                    } else {
                        for (let btn of togglePanelBtns) btn.textContent = '>';
                    }
                });
            }

            // Change screens
            function changeMenu(id) {
                if (id === 'unmenu') {
                    document.getElementById('menu').style.display = 'none';
                    document.getElementById('bells').style.display = 'none';
                    document.getElementById('layout').style.display = 'none';
                    document.getElementById('s-menu').style.display = 'none';
                    return;
                }
                document.getElementById(id).style.display = 'flex';
                document.getElementById('s-menu').style.display = 'flex';
            }
            function switchScreen(id) {
                document.getElementById(id).style.display = 'flex';
                document.getElementById(id === 'game' ? 'office' : 'game').style.display = 'none';
            }

            document.addEventListener('click', e => {
                if (e.target.dataset.changeMenu) {
                    changeMenu(e.target.dataset.changeMenu);
                } else if (e.target.dataset.switchScreen) {
                    switchScreen(e.target.dataset.switchScreen);
                }
            });

            // Student directory
            let school;
            let pictureCache;
            let directoryList = new Directory(document.getElementById('list'));

            async function dewit() {
                school = await SCHOOL.generateSchool();
                SCHEDULE.generateSchedule(school);

                school.Students.sort((x, y) => x.name.last.localeCompare(y.name.last));

                // Generate and cache student pictures
                pictureCache = new SpriteCache(school.Students.length, 'picture');
                let pictures = await getWorkerSpriteMaker()
                    .getSprites(school.Students.map(student => student.picture), true);
                for (let i = 0; i < school.Students.length; i++) {
                    school.Students[i].pictureId = pictureCache.add(pictures[i]);
                }
                directoryList.pictureCache = pictureCache;

                directoryList.students = [...school.Students];
                directoryList.updateData();
            }

            function search(name) {
                directoryList.students = school.Students
                    .filter(student => {
                        return `${student.name.last}, ${student.name.first}`
                            .toLowerCase()
                            .includes(name.toLowerCase());
                    });
                directoryList.updateData();
                directoryList.updateScroll();
            }

            let emptySchedule = [{}, {}, {}, {}, {}, {}];
            function displaySchedule(schedule=emptySchedule) {
                for (let i = 0; i < 6; i++) {
                    let row = document.getElementById('tlist' + i);
                    // Intrapersonal Discipline and Educational Nurturing for Teaching Information to Teenaged Youth
                    let clase = schedule !== emptySchedule ? schedule[i].name || 'IDENTITY' : '';
                    row.innerHTML = `<p>${'ABCDEF'[i]}</p><p>${clase}</p><p>${(schedule[i].room + 1) || ''}</p>`;
                }
            }

            directoryList.onSelect = student => {
                if (student) {
                    displaySchedule(student.schedule);
                } else {
                    displaySchedule();
                }
            };

            // TODO: Breaks if the user resizes while on the office screens
            window.addEventListener('resize', async () => {
                await directoryList.resize();
                directoryList.updateScroll();
            });

            switchScreen('game');
            changeMenu('unmenu');
            displaySchedule();

            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', () => {
                search(searchInput.value);
            });

            // Preload sprites
            // https://stackoverflow.com/questions/3646036/preloading-images-with-javascript
            new Image().src = '../sean/munkler.png';
            new Image().src = '../../characters/sprites/images/munkler/sprite.png';

            function showUI() {
                document.body.classList.remove('intro-mode');
                return Promise.all([
                    directoryList.resize()
                        .then(() => directoryList.updateScroll()),

                    // TEMP: Show the camera footage (demo?)
                    import('../sean/students-roam.js').then(({default: main}) => {
                        main(document.getElementById('camvis'));
                    })
                ]);
            }

            dewit().then(() => {
                if (param('skip-intro')) {
                    showUI();
                    return 'intro skipped';
                } else {
                    return intro(showUI);
                }
            }).then(data => {
                // Do something with whatever the user put for the name
            });
        </script>
    </body>
</html>
